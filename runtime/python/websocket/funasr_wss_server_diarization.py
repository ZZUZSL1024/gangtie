import asyncio
import json
import websockets
import time
import logging
import tracemalloc
import numpy as np
import argparse
import ssl
from scipy.spatial.distance import cosine
from modelscope.pipelines import pipeline
import torch
parser = argparse.ArgumentParser()
parser.add_argument(
    "--host", type=str, default="0.0.0.0", required=False, help="host ip, localhost, 0.0.0.0"
)
parser.add_argument("--port", type=int, default=10095, required=False, help="grpc server port")
parser.add_argument(
    "--asr_model",
    type=str,
    default="iic/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-pytorch",
    help="model from modelscope",
)
# iic/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-pytorch
# damo/speech_paraformer-large-vad-punc_asr_nat-zh-cn-16k-common-vocab8404-pytorch
parser.add_argument("--asr_model_revision", type=str, default="v2.0.4", help="")
parser.add_argument(
    "--asr_model_online",
    type=str,
    default="iic/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-online",
    help="model from modelscope",
)
parser.add_argument("--asr_model_online_revision", type=str, default="v2.0.4", help="")
parser.add_argument(
    "--vad_model",
    type=str,
    default="iic/speech_fsmn_vad_zh-cn-16k-common-pytorch",
    help="model from modelscope",
)
parser.add_argument("--vad_model_revision", type=str, default="v2.0.4", help="")
parser.add_argument(
    "--punc_model",
    type=str,
    default="iic/punc_ct-transformer_zh-cn-common-vad_realtime-vocab272727",
    help="model from modelscope",
)
parser.add_argument("--punc_model_revision", type=str, default="v2.0.4", help="")
parser.add_argument("--ngpu", type=int, default=1, help="0 for cpu, 1 for gpu")
parser.add_argument("--device", type=str, default="cuda", help="cuda, cpu")
parser.add_argument("--ncpu", type=int, default=4, help="cpu cores")
parser.add_argument(
    "--certfile",
    type=str,
    default="../../ssl_key/server.crt",
    required=False,
    help="certfile for ssl",
)

parser.add_argument(
    "--keyfile",
    type=str,
    default="../../ssl_key/server.key",
    required=False,
    help="keyfile for ssl",
)
args = parser.parse_args()


websocket_users = set()

print("model loading")
from funasr import AutoModel

# asr
model_asr = AutoModel(
    model=args.asr_model,
    model_revision=args.asr_model_revision,
    ngpu=args.ngpu,
    ncpu=args.ncpu,
    device=args.device,
    disable_pbar=True,
    disable_log=True,
)
# asr
model_asr_streaming = AutoModel(
    model=args.asr_model_online,
    model_revision=args.asr_model_online_revision,
    ngpu=args.ngpu,
    ncpu=args.ncpu,
    device=args.device,
    disable_pbar=True,
    disable_log=True,
)
# vad
model_vad = AutoModel(
    model=args.vad_model,
    model_revision=args.vad_model_revision,
    ngpu=args.ngpu,
    ncpu=args.ncpu,
    device=args.device,
    disable_pbar=True,
    disable_log=True,
    # chunk_size=60,
)

if args.punc_model != "":
    model_punc = AutoModel(
        model=args.punc_model,
        model_revision=args.punc_model_revision,
        ngpu=args.ngpu,
        ncpu=args.ncpu,
        device=args.device,
        disable_pbar=True,
        disable_log=True,
    )
else:
    model_punc = None

# sv
model_sv = AutoModel(
    model="iic/speech_campplus_sv_zh-cn_16k-common",
    ngpu=args.ngpu,
    device=args.device,
    disable_pbar=True,
    disable_log=True,
)
model_diarization = AutoModel(
    model="iic/speech_diarization",
    ngpu=args.ngpu,
    device=args.device,
)
speaker_db={
    #"丁光宇":"[-0.2894182801246643, 2.4119157791137695, 0.4632640480995178, 0.455464631319046, -0.38790586590766907, -1.2271867990493774, -0.3538948595523834, 0.7137840390205383, 1.3016458749771118, -0.019390255212783813, -0.13299837708473206, 2.3476154804229736, 0.2265334129333496, 1.0667674541473389, -0.22172588109970093, 1.2630646228790283, 0.3237226605415344, 1.4421671628952026, 0.39679327607154846, -0.3102840185165405, 0.023684024810791016, -0.9171885251998901, -0.0275995135307312, -0.33200913667678833, -0.18310412764549255, -1.237714171409607, -0.9634658694267273, 0.9288116693496704, 0.014981269836425781, -0.6487887501716614, 0.3941420912742615, -0.36590147018432617, 0.428011417388916, 1.4433681964874268, -0.6012353897094727, 0.00032341480255126953, 0.35519540309906006, -2.326387405395508, 1.026390790939331, 0.5966520309448242, -0.8884506225585938, -0.3799850344657898, 0.14619141817092896, -1.71479070186615, -0.12069875001907349, 0.006016045808792114, -0.2160152792930603, 0.21793323755264282, -0.4154106676578522, 1.9042105674743652, -1.2742416858673096, -0.10192053020000458, 0.8494903445243835, -0.05026817321777344, -0.7822666168212891, -1.362255334854126, -1.3383221626281738, -0.05546849966049194, -0.35244664549827576, 0.22171397507190704, 0.7396962642669678, -0.4593645930290222, -0.5746256113052368, 1.1789660453796387, -1.0806732177734375, -0.5697298049926758, -0.23719072341918945, -0.7025287747383118, -0.30080917477607727, 0.25115448236465454, 0.5526198148727417, -0.25024887919425964, 1.5789754390716553, 0.5747674703598022, -0.4502490758895874, -0.05633397400379181, -1.1077334880828857, 1.2783700227737427, 2.0895638465881348, -0.4116848409175873, 0.05477531626820564, -1.3986759185791016, -0.30075007677078247, -0.7986224889755249, 0.8379559516906738, -0.49693411588668823, -1.324018955230713, -0.453191876411438, 2.7160329818725586, -1.0634596347808838, -0.5435076951980591, -1.0890767574310303, 0.19415920972824097, 1.1033921241760254, -0.011205732822418213, 1.656747579574585, 1.3499846458435059, 1.4626812934875488, -0.29715168476104736, -0.31554093956947327, 0.7011764645576477, -1.507362723350525, -0.07132112979888916, 0.8788689374923706, -1.1379073858261108, 0.595555305480957, -0.38353896141052246, 0.3712570071220398, 1.550696849822998, -1.307342767715454, -0.47517430782318115, -1.1095696687698364, -0.9100558757781982, -2.457692861557007, -0.2806183695793152, 0.9321286082267761, -0.9155192375183105, 1.6019104719161987, 1.3411370515823364, 0.7263191342353821, 0.5655620098114014, -0.6035930514335632, 0.6513776183128357, 0.8367354869842529, 1.2926439046859741, 0.667155385017395, 0.40038931369781494, -1.5844635963439941, -0.9970234632492065, 1.6927180290222168, -0.9389147162437439, 1.0594146251678467, -1.2404576539993286, -0.024859368801116943, -0.06708523631095886, 0.8246246576309204, 0.10707807540893555, -1.3933435678482056, 0.9709909558296204, 0.4017466902732849, 0.024082019925117493, 0.6248972415924072, 0.15584027767181396, -1.5958768129348755, 0.024387240409851074, 0.4759272336959839, 0.4057701826095581, -1.8725571632385254, -1.322962999343872, -0.11611288785934448, -1.1735444068908691, -0.1274237334728241, -0.7194994688034058, -0.235042542219162, -0.26873862743377686, -0.6916401386260986, -0.18675214052200317, -1.5003459453582764, 0.3420657813549042, -1.5722779035568237, -2.2757720947265625, 2.2156190872192383, -0.01713663339614868, -0.10326516628265381, 1.0105695724487305, -0.7040106058120728, -1.0314970016479492, -1.0052694082260132, 0.13405898213386536, -0.7786321043968201, 0.9141744375228882, -0.11057533323764801, -0.2807677984237671, 0.5401194095611572, -0.8344421982765198, -0.5496228933334351, 0.9969579577445984, -0.04264754056930542, 0.7071061134338379, 0.5182119607925415, 1.010628581047058, -1.5436408519744873, 0.47405874729156494, -1.249784231185913, 0.6347591876983643, -0.5586827993392944, -0.16116386651992798, -1.005288004875183, 1.803063988685608, 0.8938459753990173, -0.3608861565589905, -0.6615474224090576]",
    "丁光宇":"[-0.49795225262641907, 1.9173810482025146, 0.31492650508880615, 0.2800883948802948, -0.3242886960506439, -0.5066536664962769, -1.0430313348770142, 0.5124462246894836, 1.372861623764038, 0.4030326008796692, 0.44963961839675903, 2.406324863433838, 0.04792529344558716, 1.8830626010894775, 0.11756902933120728, 0.2694530189037323, 0.908281147480011, 1.206369161605835, 1.0865494012832642, -0.1724923849105835, -0.05896550416946411, -0.6760150194168091, 0.2868877053260803, 0.020042123273015022, -0.6110150814056396, -1.1625698804855347, -1.0454739332199097, 1.036311149597168, 0.4824693202972412, -0.1884848177433014, -0.0020624473690986633, -0.518440842628479, 0.6572728753089905, 1.0534123182296753, -1.3968150615692139, -0.42910003662109375, 0.2537049353122711, -2.281787157058716, 0.8157077431678772, -0.23617656528949738, -0.22357343137264252, -0.6994542479515076, 0.26571813225746155, -0.5851593017578125, -0.2746015191078186, 0.010073274374008179, 0.5769595503807068, 0.336117148399353, -0.45322945713996887, 1.459653377532959, -1.240509033203125, -0.6314233541488647, 0.9210934638977051, 0.11065521836280823, -0.38240647315979004, -1.4367998838424683, -0.5456624627113342, -0.3779293894767761, 0.031015345826745033, 0.5831231474876404, 1.215519905090332, -0.8113278150558472, -0.33748364448547363, 1.513347864151001, -0.9864439368247986, -0.7269114255905151, -0.2503812313079834, -0.3677770495414734, 0.029609203338623047, 0.26226556301116943, 1.2929039001464844, -0.17132879793643951, 0.4743005633354187, 0.37290963530540466, -0.9589248895645142, 0.7961002588272095, -1.2946295738220215, 1.1888840198516846, 1.6725679636001587, -0.7485917806625366, 0.2827067971229553, -0.9143877029418945, -0.9747892022132874, -0.999900221824646, 0.20787058770656586, -0.5626111626625061, -1.7729034423828125, 0.2675475478172302, 2.542062759399414, -1.499840497970581, -0.2761151194572449, -1.155019998550415, 0.6373496055603027, 0.8464840650558472, -0.30929034948349, 1.2859386205673218, 1.2173607349395752, 1.3661096096038818, 0.17042197287082672, -0.2858004868030548, 0.45626935362815857, -0.9317016005516052, 0.4561846852302551, 1.0392974615097046, -0.9635242819786072, 0.4950682520866394, -0.39965200424194336, 0.5882121324539185, 1.2817881107330322, -1.064394474029541, -0.81183922290802, -0.5966437458992004, -1.3883745670318604, -2.041459798812866, 0.07398959994316101, 1.656151294708252, -0.7590104341506958, 1.4850560426712036, 1.822554588317871, 0.6143965721130371, 0.1742110252380371, -0.6585709452629089, 0.9455776214599609, 0.22064000368118286, 0.866059422492981, 1.0071793794631958, 0.11116301268339157, -1.1495635509490967, -0.4223463535308838, 1.385462760925293, -0.6579128503799438, 1.199960708618164, -1.1310944557189941, 0.3535812497138977, -0.5220102667808533, 0.8296295404434204, 0.2480756938457489, -1.1150907278060913, 1.5943461656570435, 0.5658608675003052, -0.46360066533088684, 0.6743350028991699, -0.04867905378341675, -1.894758701324463, -0.23503953218460083, 0.20428423583507538, 0.7269930243492126, -1.0223308801651, -1.48202383518219, -0.14199531078338623, -1.1042163372039795, -0.24085018038749695, -0.6401645541191101, -0.35836711525917053, 0.06568190455436707, -0.3219820261001587, -0.36875081062316895, -1.173001766204834, 0.3639872372150421, -1.0075736045837402, -1.2064810991287231, 1.5656991004943848, -0.09614691138267517, 0.5316434502601624, 1.0901224613189697, -1.1888536214828491, -0.44946718215942383, -1.435091257095337, 0.03211396932601929, -1.2357265949249268, 0.8832491636276245, -0.34776079654693604, -1.1214370727539062, 0.3705711364746094, -0.8815572261810303, -0.596265971660614, 1.4729423522949219, 0.15303310751914978, 1.213356852531433, 0.5520530343055725, 0.7200618386268616, -0.6458541750907898, 0.22970175743103027, -1.9703369140625, 0.4603327512741089, -0.863031268119812, 0.6310061812400818, -0.6878098249435425, 2.25201416015625, 0.12672406435012817, -0.5793861150741577, 0.4263423681259155]",
    "易永亮":"[-0.36722612380981445, 1.7580028772354126, 1.4368969202041626, -0.31901422142982483, -0.4056660532951355, -0.9656704068183899, 1.3489234447479248, 0.14139920473098755, 0.21839094161987305, -0.13119879364967346, 1.1093673706054688, 0.5937820076942444, 0.41322970390319824, -0.09055125713348389, 1.2774105072021484, 0.33860504627227783, 1.5337573289871216, 0.0812358558177948, -0.3611944615840912, 0.6425189971923828, -0.4157412052154541, -0.8171511888504028, 0.21691322326660156, 0.6861987709999084, 0.261264443397522, -1.0323392152786255, -0.9658790230751038, 1.3770501613616943, -0.7099875807762146, -2.3838469982147217, -0.8066839575767517, -0.3980363607406616, 1.1498382091522217, -0.3246309459209442, -2.2283642292022705, -0.58961421251297, 0.6359772682189941, -0.2101215124130249, 0.05289437621831894, -0.5327892899513245, 0.08641406893730164, -0.5767199397087097, -0.3882427215576172, -0.03632113337516785, -0.6503337025642395, -0.5814478397369385, -0.42234712839126587, -1.3337736129760742, -0.41753363609313965, 0.14443081617355347, 0.10314586758613586, -2.110065460205078, 1.199155569076538, 0.20174559950828552, -2.290322780609131, 0.06948822736740112, 0.39864614605903625, 0.778484046459198, -1.2325384616851807, 0.24601158499717712, 0.38520488142967224, -1.1221009492874146, 0.49164387583732605, 0.5031643509864807, 0.4063462018966675, -0.26481854915618896, 0.6162029504776001, -0.30913275480270386, 0.5093497037887573, -0.21759861707687378, -0.0792585164308548, -0.5751667618751526, 1.216646671295166, -0.03203284740447998, -0.8147829174995422, -0.360618531703949, -0.9875293970108032, 1.475890874862671, 0.5941718816757202, 0.663848876953125, 0.5790947675704956, -0.5038809776306152, -0.6630961298942566, -0.6997244358062744, -0.7048660516738892, -1.0377020835876465, -0.26072871685028076, -1.360460877418518, 1.55818510055542, -1.399427890777588, -0.05190953239798546, 0.5212257504463196, 0.22319447994232178, 0.505282998085022, -0.18514466285705566, 1.6106435060501099, 0.9133050441741943, -0.09319651126861572, 0.9263599514961243, 0.4706592261791229, 0.6953070163726807, -1.885541319847107, 0.19252632558345795, 1.0459709167480469, -0.27333855628967285, -0.10705244541168213, -0.3000759780406952, 2.2318501472473145, 1.6675828695297241, -2.25662899017334, -1.2601778507232666, -0.6802695989608765, 0.1657973825931549, -1.905479907989502, -0.08967085182666779, 0.3243643641471863, 0.20216810703277588, 0.3531420826911926, 1.6294090747833252, 0.0008709393441677094, 0.5117150545120239, -1.062333106994629, 0.9550252556800842, -0.3054344952106476, 1.1921343803405762, 0.4736390709877014, -0.3244848847389221, -0.8017666935920715, -1.318241000175476, -0.0449753999710083, -0.3074650466442108, -1.268052577972412, 0.09124091267585754, -0.37256288528442383, -1.6205013990402222, -0.5615412592887878, 0.7139641046524048, 0.24927100539207458, 0.5164322853088379, 0.6502490043640137, 0.9208258390426636, 0.26273685693740845, 0.9162101745605469, -1.2291183471679688, 0.7353005409240723, -0.9911043047904968, 0.06878454238176346, -1.333274483680725, 0.4776075482368469, -0.7909662127494812, -0.5290279984474182, 0.816257119178772, -0.4574834406375885, 0.6753177642822266, -0.09122300148010254, -1.344406008720398, 0.18808507919311523, 0.40364307165145874, -1.4919248819351196, -1.3179130554199219, -1.0276179313659668, 0.7097841501235962, -1.215367317199707, 0.22590169310569763, 0.3136228919029236, -0.6539829969406128, 1.0783767700195312, -0.895635187625885, 0.1290166974067688, -1.3979506492614746, 0.4037543833255768, -0.6269939541816711, -2.0661609172821045, 0.3981451988220215, -0.18797525763511658, -0.6373803019523621, 0.8988460898399353, -0.6845536828041077, 0.23452581465244293, 1.5592697858810425, 0.027406886219978333, 1.3372178077697754, -0.11107933521270752, -0.7196969985961914, -0.06448088586330414, -1.012230634689331, 1.284761667251587, 1.329944133758545, 0.6475231647491455, 0.2934182286262512, -0.04672616720199585, 0.23377424478530884]",
    "张仕林":"[-0.5007596611976624, 1.78812837600708, 0.7535582780838013, -0.4896135926246643, 0.02069208025932312, 1.0501022338867188, 0.9104741811752319, -0.1484367847442627, -1.2633662223815918, 0.49446117877960205, 0.5156641602516174, -0.5726549625396729, 1.1277668476104736, -0.6425521373748779, -0.6169285178184509, -0.25572192668914795, 1.4944602251052856, 0.7805182933807373, -0.1943991482257843, -0.35647714138031006, 0.3514808714389801, -0.5611366033554077, 1.4797520637512207, 0.11944857239723206, -0.3593825399875641, -1.655731439590454, -0.45581018924713135, -0.22943663597106934, -0.6863011121749878, 1.8582643270492554, -0.292929470539093, -2.357339859008789, 2.7752721309661865, -1.5424102544784546, -0.8577829003334045, -0.43555501103401184, -0.39479413628578186, 0.133559912443161, 0.27474766969680786, 0.33070382475852966, -0.4796839654445648, 0.02941986918449402, 0.6851270794868469, 0.046011924743652344, -0.3989276885986328, -0.18489839136600494, -0.7909715175628662, -1.3652989864349365, -1.1303023099899292, -0.3552391827106476, -0.00635528564453125, 0.4550660252571106, -0.5903394222259521, -0.7324382662773132, -1.6859078407287598, 0.7485366463661194, 0.4499867558479309, 0.7660162448883057, -0.7925806045532227, -0.9857627749443054, -0.743247389793396, -0.014146119356155396, 1.1271946430206299, -0.9400162696838379, 0.5307481288909912, -1.402609944343567, -0.002654552459716797, -1.0615594387054443, -0.86388099193573, -0.9853454232215881, -0.3816280961036682, 0.02431853674352169, 0.7619155049324036, 0.061149463057518005, 0.46419423818588257, -1.5776230096817017, -0.19100812077522278, 1.3999115228652954, 0.29247963428497314, 0.5067810416221619, -0.6612273454666138, 0.9966771006584167, -0.9709568619728088, -0.2711235582828522, 0.8445019125938416, 0.8169751167297363, -0.5697389245033264, -0.8680288791656494, 1.0163183212280273, -0.9655720591545105, -0.49974656105041504, -0.10943603515625, 1.592016577720642, 1.6827991008758545, 0.4429381489753723, 0.17738038301467896, 0.10038956999778748, 0.3210635781288147, -0.18814611434936523, 0.04599840193986893, 0.44022873044013977, -2.052231788635254, 0.45066386461257935, 0.7757773995399475, 0.4051503837108612, 0.22288376092910767, -0.4873368740081787, 0.5670003890991211, 0.25262168049812317, -0.391594797372818, 0.09594246745109558, -1.060184121131897, -0.2772429585456848, -0.5656912326812744, 0.2900245785713196, -1.026303768157959, -0.5896430015563965, 1.0621280670166016, 1.4065029621124268, 0.41967660188674927, -0.5382488369941711, -1.8335580825805664, 1.3584829568862915, -1.1021595001220703, 0.2887573838233948, -0.9281469583511353, -0.3502374291419983, 0.4399890899658203, -0.5237648487091064, -1.1646885871887207, 1.2560408115386963, -0.7608563303947449, -0.34548965096473694, 0.11787527799606323, -0.5914205312728882, 0.24164053797721863, 0.15871676802635193, 0.5750336647033691, -0.8168342709541321, 1.4491745233535767, -0.048187971115112305, -0.9787353873252869, 0.17980414628982544, -0.25590771436691284, 0.11463591456413269, -1.7045408487319946, 0.7267696261405945, -1.1380939483642578, 0.7413800358772278, 0.8575687408447266, 0.41545602679252625, 0.349387526512146, 0.5795409679412842, -0.1551695168018341, 0.45223045349121094, 0.40785664319992065, 1.251323938369751, -1.5992668867111206, -0.2869396507740021, -1.0155210494995117, 1.4146839380264282, 0.7081840634346008, 0.09566017985343933, 0.07616287469863892, 0.386989951133728, -0.38045528531074524, -1.0401657819747925, 0.6421335935592651, -1.1532098054885864, 0.02244114875793457, 0.40277689695358276, -0.9848252534866333, -0.9447308778762817, 0.17466461658477783, -0.12099534273147583, 0.3299047648906708, 0.718330442905426, -1.5803961753845215, 0.3401556611061096, 0.2900581955909729, -0.48553377389907837, 2.555988073348999, 0.9498685598373413, -0.649253249168396, -1.5641894340515137, -0.2632443904876709, 1.5458948612213135, 0.3989548683166504, 0.35121047496795654, 0.7038964629173279, -0.7302312850952148, -0.5371677279472351]",
    "李文俊":"[0.13162711262702942, 1.7246289253234863, 0.05149010568857193, -0.17850570380687714, 0.9539167284965515, -1.5296733379364014, 1.016239047050476, 0.7330749034881592, 1.0881386995315552, 0.12196701765060425, 0.664216160774231, 0.805231511592865, 0.26039624214172363, -0.6895135045051575, -0.16506052017211914, -0.9351843595504761, 0.6510933637619019, 2.030867338180542, 1.264122486114502, 0.3435366153717041, -1.0941606760025024, -0.47069764137268066, 1.2551350593566895, -1.2882357835769653, -1.3139103651046753, 0.12367647886276245, -0.8491014838218689, 0.6517194509506226, -0.15381847321987152, -0.3586103916168213, -1.8719249963760376, -1.6960465908050537, -0.038700103759765625, -1.196049451828003, -0.5840214490890503, -1.7187414169311523, 0.41497769951820374, 2.0417001247406006, 0.6917951107025146, -0.44054800271987915, -0.018192335963249207, -0.026122644543647766, -0.3403084874153137, 1.0899769067764282, 0.3274348974227905, -1.2249685525894165, 0.6809961199760437, 1.41376531124115, -0.7379493117332458, -0.1449957638978958, 1.066613793373108, -0.5404934287071228, 0.8047165274620056, -0.1074177622795105, -0.25397437810897827, -0.6261929273605347, 0.2714659869670868, -1.0053322315216064, 0.9413051009178162, -0.5218299031257629, -0.02824510633945465, 2.3515567779541016, 1.788670301437378, 0.4522241950035095, 0.6560952663421631, -0.3091771602630615, -1.9100757837295532, 0.1356654167175293, -0.7853569984436035, -0.8419042229652405, -1.247647762298584, 0.07028773427009583, -0.13133454322814941, -1.2498836517333984, 0.008529074490070343, -0.22879146039485931, 0.16167545318603516, -0.1768968403339386, -0.7054018974304199, 0.7154746055603027, -0.19931907951831818, -0.6108332872390747, -0.9574530720710754, -1.207622766494751, 0.28715580701828003, -0.6787720918655396, 1.07743501663208, 0.24845004081726074, -0.04829239845275879, -1.9201791286468506, -0.9859687685966492, -0.5877179503440857, 2.8494062423706055, 0.5320805311203003, 0.4031636118888855, -0.10666996240615845, -1.5767346620559692, 0.0052012428641319275, 1.109568476676941, 1.6007846593856812, 0.35313913226127625, -1.3262733221054077, 0.13358044624328613, 0.006273888051509857, -0.9079645872116089, 1.4469022750854492, -0.8115692138671875, -1.2218624353408813, 0.7464962005615234, -1.5170807838439941, -0.8175776600837708, 0.2322622686624527, 0.5422022938728333, -0.25536400079727173, -0.6559136509895325, -0.4187294840812683, -1.2812459468841553, -0.815041184425354, 0.5162556171417236, 0.25074753165245056, -0.4877714216709137, 0.19689133763313293, 1.8270028829574585, -0.19437909126281738, 0.6090781688690186, 0.23108574748039246, -0.18468409776687622, 0.3046761453151703, -2.162130832672119, -0.8123758435249329, 0.12512919306755066, -0.6611927151679993, -0.5339052677154541, 0.7385041117668152, -0.4183940887451172, -1.6228365898132324, 0.9319873452186584, -0.3390601873397827, -0.6105111837387085, -0.24085727334022522, 0.00012978911399841309, -0.6974319219589233, 0.3115379512310028, -0.3666590750217438, 3.0251924991607666, 1.4867297410964966, -0.07712948322296143, 0.4478629529476166, 0.2905183434486389, 0.2299536168575287, -0.9049630165100098, 1.0598052740097046, 0.03972441703081131, -0.4877702295780182, 1.510378122329712, 0.3942996859550476, -0.2091904580593109, -0.47539806365966797, -0.9603050947189331, 0.4958987832069397, -1.6826046705245972, -0.2077266424894333, 0.058316439390182495, 0.15281465649604797, 0.20941495895385742, 0.10178208351135254, -1.40911066532135, -1.36489737033844, 0.6395122408866882, -2.5883874893188477, 0.4908418357372284, 0.7832932472229004, 0.17728683352470398, 1.168858528137207, 0.09868365526199341, -0.5921443700790405, 0.34858381748199463, -0.2681841254234314, 0.5475165247917175, -0.7539958953857422, 0.9469073414802551, 0.5486859679222107, 0.49290865659713745, -0.5839287042617798, 0.32107242941856384, -2.112372398376465, 0.9586502313613892, -0.33752524852752686, 0.7680233716964722, -0.11639881134033203, 0.8034487962722778, -2.1820290088653564]"

}
print("model loaded! only support one client at the same time now!!!!")


async def ws_reset(websocket):
    print("ws reset now, total num is ", len(websocket_users))

    websocket.status_dict_asr_online["cache"] = {}
    websocket.status_dict_asr_online["is_final"] = True
    websocket.status_dict_vad["cache"] = {}
    websocket.status_dict_vad["is_final"] = True
    websocket.status_dict_punc["cache"] = {}

    await websocket.close()


async def clear_websocket():
    for websocket in websocket_users:
        await ws_reset(websocket)
    websocket_users.clear()


async def ws_serve(websocket, path):
    frames = []
    frames_asr = []
    frames_asr_online = []
    global websocket_users
    # await clear_websocket()
    websocket_users.add(websocket)
    websocket.status_dict_asr = {}
    websocket.status_dict_asr_online = {"cache": {}, "is_final": False}
    websocket.status_dict_vad = {"cache": {}, "is_final": False}
    websocket.status_dict_punc = {"cache": {}}
    websocket.chunk_interval = 10
    websocket.vad_pre_idx = 0
    speech_start = False
    speech_end_i = -1
    websocket.wav_name = "microphone"
    websocket.mode = "2pass"
    print("new user connected", flush=True)

    try:
        async for message in websocket:
            if isinstance(message, str):
                messagejson = json.loads(message)
                print("=============messagejson============",messagejson)
                if "is_speaking" in messagejson:
                    websocket.is_speaking = messagejson["is_speaking"]
                    websocket.status_dict_asr_online["is_final"] = not websocket.is_speaking
                if "chunk_interval" in messagejson:
                    websocket.chunk_interval = messagejson["chunk_interval"]
                if "wav_name" in messagejson:
                    websocket.wav_name = messagejson.get("wav_name")
                if "chunk_size" in messagejson:
                    chunk_size = messagejson["chunk_size"]
                    if isinstance(chunk_size, str):
                        chunk_size = chunk_size.split(",")
                    websocket.status_dict_asr_online["chunk_size"] = [int(x) for x in chunk_size]
                if "encoder_chunk_look_back" in messagejson:
                    websocket.status_dict_asr_online["encoder_chunk_look_back"] = messagejson[
                        "encoder_chunk_look_back"
                    ]
                if "decoder_chunk_look_back" in messagejson:
                    websocket.status_dict_asr_online["decoder_chunk_look_back"] = messagejson[
                        "decoder_chunk_look_back"
                    ]
                if "hotwords" in messagejson:
                    websocket.status_dict_asr["hotword"] = messagejson["hotwords"]
                if "mode" in messagejson:
                    websocket.mode = messagejson["mode"]


            websocket.status_dict_vad["chunk_size"] = int(
                websocket.status_dict_asr_online["chunk_size"][1] * 60 / websocket.chunk_interval
            )
            if len(frames_asr_online) > 0 or len(frames_asr) >= 0 or not isinstance(message, str):
                if not isinstance(message, str):
                    frames.append(message)
                    duration_ms = len(message) // 32
                    websocket.vad_pre_idx += duration_ms

                    # asr online
                    frames_asr_online.append(message)
                    websocket.status_dict_asr_online["is_final"] = speech_end_i != -1
                    if (
                        len(frames_asr_online) % websocket.chunk_interval == 0
                        or websocket.status_dict_asr_online["is_final"]
                    ):
                        if websocket.mode == "2pass" or websocket.mode == "online":
                            audio_in = b"".join(frames_asr_online)
                            try:
                                await async_asr_online(websocket, audio_in)
                            except:
                                print(f"error in asr streaming, {websocket.status_dict_asr_online}")
                        frames_asr_online = []
                    if speech_start:
                        frames_asr.append(message)
                    # vad online
                    try:
                        speech_start_i, speech_end_i = await async_vad(websocket, message)

                    except:
                        print("error in vad")
                    if speech_start_i != -1:
                        speech_start = True
                        beg_bias = (websocket.vad_pre_idx - speech_start_i) // duration_ms
                        frames_pre = frames[-beg_bias:]
                        frames_asr = []
                        frames_asr.extend(frames_pre)
                # asr punc offline
                if speech_end_i != -1 or not websocket.is_speaking:

                    if websocket.mode == "2pass" or websocket.mode == "offline":
                        audio_in = b"".join(frames_asr)
                        try:
                            await async_asr(websocket, audio_in)
                        except:
                            print("error in asr offline")
                    frames_asr = []
                    speech_start = False
                    frames_asr_online = []
                    websocket.status_dict_asr_online["cache"] = {}
                    if not websocket.is_speaking:
                        websocket.vad_pre_idx = 0
                        frames = []
                        websocket.status_dict_vad["cache"] = {}
                    else:
                        frames = frames[-20:]

    except websockets.ConnectionClosed:
        print("ConnectionClosed...", websocket_users, flush=True)
        await ws_reset(websocket)
        websocket_users.remove(websocket)
    except websockets.InvalidState:
        print("InvalidState...")
    except Exception as e:
        print("Exception:", e)


async def async_vad(websocket, audio_in):

    segments_result = model_vad.generate(input=audio_in, **websocket.status_dict_vad)[0]["value"]
    # print(segments_result)

    speech_start = -1
    speech_end = -1

    if len(segments_result) == 0 or len(segments_result) > 1:
        return speech_start, speech_end
    if segments_result[0][0] != -1:
        speech_start = segments_result[0][0]
    if segments_result[0][1] != -1:
        speech_end = segments_result[0][1]
    return speech_start, speech_end


async def async_asr(websocket, audio_in):
    if len(audio_in) > 0:
        # print(len(audio_in))
        rec_result = model_asr.generate(input=audio_in, **websocket.status_dict_asr)[0]
        # 需要在此处做声纹分离及声纹对比
        spk_name = "unknown"  # 默认未知说话人
        best_score=0.0
        try:
            # 提取当前音频的声纹特征
            # automodel
            embedding = model_sv.generate(
                input=audio_in,
                embedding=True
            )[0]["spk_embedding"][0].numpy()

            # 与注册库对比
            if len(speaker_db) > 0:
                for name, ref_embedding in speaker_db.items():
                    if ref_embedding is not None:
                        # 计算余弦相似度
                        data_list = json.loads(ref_embedding)
                        arr = np.array(data_list, dtype=np.float32)
                        similarity = 1 - cosine(embedding, arr)
                        print(similarity)
                        # 找到最匹配的说话人（阈值 0.5）
                        if similarity > best_score and similarity > 0.2:
                            best_score = similarity
                            spk_name = name
        except Exception as e:
            print(f"声纹识别失败: {e}")

        print("offline_asr, ", rec_result)
        # 标点恢复
        if model_punc is not None and len(rec_result["text"]) > 0:
            print("offline, before punc", rec_result, "cache", websocket.status_dict_punc)
            rec_result = model_punc.generate(
                input=rec_result["text"], **websocket.status_dict_punc
            )[0]
            print("offline, after punc", rec_result)
        #  返回结果
        if len(rec_result["text"]) > 0:
            print("======offline", rec_result)
            mode = "2pass-offline" if "2pass" in websocket.mode else websocket.mode
            message = json.dumps(
                {
                    "mode": mode,
                    "spk_name":spk_name,
                    "spk_score":best_score,
                    "text": rec_result["text"],
                    "wav_name": websocket.wav_name,
                    "is_final": websocket.is_speaking,
                }
            )
            await websocket.send(message)

    else:
        mode = "2pass-offline" if "2pass" in websocket.mode else websocket.mode
        message = json.dumps(
            {
                "mode": mode,
                "text": "",
                "wav_name": websocket.wav_name,
                "is_final": websocket.is_speaking,
            }
        )
        await websocket.send(message)

async def async_asr_online(websocket, audio_in):
    if len(audio_in) > 0:
        # print(websocket.status_dict_asr_online.get("is_final", False))
        rec_result = model_asr_streaming.generate(
            input=audio_in, **websocket.status_dict_asr_online
        )[0]
        print("online, ", rec_result)
        if websocket.mode == "2pass" and websocket.status_dict_asr_online.get("is_final", False):
            return
            #     websocket.status_dict_asr_online["cache"] = dict()
        if len(rec_result["text"]):
            mode = "2pass-online" if "2pass" in websocket.mode else websocket.mode
            message = json.dumps(
                {
                    "mode": mode,
                    "text": rec_result["text"],
                    "wav_name": websocket.wav_name,
                    "is_final": websocket.is_speaking,
                }
            )
            await websocket.send(message)


if len(args.certfile) > 0:
    ssl_context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)

    # Generate with Lets Encrypt, copied to this location, chown to current user and 400 permissions
    ssl_cert = args.certfile
    ssl_key = args.keyfile

    ssl_context.load_cert_chain(ssl_cert, keyfile=ssl_key)
    start_server = websockets.serve(
        ws_serve, args.host, args.port, subprotocols=["binary"], ping_interval=None, ssl=ssl_context
    )
else:
    start_server = websockets.serve(
        ws_serve, args.host, args.port, subprotocols=["binary"], ping_interval=None
    )
asyncio.get_event_loop().run_until_complete(start_server)
asyncio.get_event_loop().run_forever()